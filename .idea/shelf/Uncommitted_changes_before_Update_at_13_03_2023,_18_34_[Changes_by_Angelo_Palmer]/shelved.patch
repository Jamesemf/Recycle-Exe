Index: bytebrigade/barcodereader/views.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>from django.shortcuts import render, redirect\nimport urllib.request\nimport json\nfrom home.models import Statistic, Product, BinData, Transaction, UserGoal\nfrom datetime import datetime\nfrom django.db.models import Q\n\n\ndef barcode_lookup(request):\n    # If the user not log-in, redirect them to login page\n    if not request.user.is_authenticated:\n        return redirect('login')\n    if request.method == 'POST':\n        barcode_product = request.POST.get(\"barcode\")\n        # We set the session barcode so that we can then use it in the other areas of the project\n        request.session['barcode'] = barcode_product\n        request.session['valid'] = 1\n        if Product.objects.filter(barcode=barcode_product).exists():\n            return redirect('recycle_confirm')\n            # redirect to product recycle page\n        else:\n            return redirect('create_product')\n\n    else:\n        return render(request, 'BCscanner/Scanner_page.html')\n\n\ndef create_product(request):\n    # we need to send the user to a page that contains a form\n    # Ask the user for the weight and material of the product\n    # Then add the product to the database\n    # request.session['new_product'] = False\n    if not request.user.is_authenticated:\n        return redirect('login')\n    if request.method == 'POST':\n        form = request.POST\n        new_product = Product.objects.create(\n            barcode=form.get(\"barcode\"),\n            name=form.get(\"name\"),\n            weight=float(form.get(\"weight\")) / 1000,\n            material=form.get(\"material\"),\n            recycle=form.get(\"recycle\")\n        )\n        new_product.save()\n\n        product_data = Product.objects.get(barcode=form.get(\"barcode\"))\n        addstats(request.user, product_data, 50)\n\n        request.session['new_product'] = True\n\n        return redirect('recycle_confirm')\n    elif request.session['barcode'] != -1:\n        if not Product.objects.filter(barcode=request.session['barcode']).exists():\n            barcode = {'barcode': request.session['barcode']}\n            return render(request, 'BCscanner/new_product_page.html', barcode)\n        else:\n            return redirect('index')\n    return redirect('index')\n\n\ndef recycle_confirm(request):\n    # The function that handles recording a transaction\n    # Then it shows you to a popup showing what stats you gained on the home_page\n    if not request.user.is_authenticated:\n        return redirect('login')\n    try:\n        if not request.session['valid'] == 1:\n            return redirect('index')\n    except Exception as e:\n        print(e)\n        return redirect(\"index\")\n\n    try:\n        barcode_product = request.session['barcode']\n        bin_data = request.session['bin_data']\n        if Product.objects.filter(barcode=barcode_product).exists() \\\n                and BinData.objects.filter(binId=bin_data).exists():\n            product_data = Product.objects.get(barcode=barcode_product)\n            user_data = request.user\n            cur_time = (datetime.now()).strftime(\"%H:%M:%S\")\n            bin_data = BinData.objects.get(binId=bin_data)\n            new_transaction = Transaction.objects.create(\n                product=product_data,\n                user=user_data,\n                time=cur_time,\n                bin=bin_data,\n            )\n            new_transaction.save()\n            request.session['barcode'] = -1\n            request.session['bin_data'] = -1\n            request.session['valid'] = -1\n        # Call a function that will take in the calculate the points for the user\n        # If the product is new add points, this is handle in the create product part\n        # def addstats(points,kg)\n            weight = product_data.weight\n            points = round(weight * 122)\n            # need to include the product\n            addstats(request.user, product_data, points, weight)\n\n            # If statement that checks what the products type is and then we set a variable that is litrally\n            # var = 'Put in the red bin'\n\n            product_type = product_data.material\n            could_recycle = product_data.recycle\n            new_home = \"\"\n            match (product_type, could_recycle):\n                case (\"Paper\", \"True\"):\n                    new_home = \"My new home is the Paper bin, please help me find my home! :)\"\n                    binType = 'Paper'\n                case (\"Plastic\", \"True\"):\n                    new_home = \"My new home is the Plastic bin, please help me find my home! :)\"\n                    binType = 'Plastic'\n                case (\"Cans\", \"True\"):\n                    new_home = \"My new home is the Cans bin, please help me find my home! :)\"\n                    binType = 'Cans'\n                case (\"Glass\", \"True\"):\n                    new_home = \"My new home is the Glass bin, please help me find my home! :)\"\n                    binType = 'Glass'\n                case (\"Plastic\", \"False\"):\n                    new_home = \"I am non-recyclable, please put me into General Waste :(\"\n                case (\"Cans\", \"False\"):\n                    new_home = \"I am non-recyclable, please put me into General Waste :(\"\n                case (\"Non-Recyclable\", \"False\"):\n                    new_home = \"I am non-recyclable, please put me into General Waste :(\"\n                case (\"Glass\", \"False\"):\n                    new_home = \"I am non-recyclable, please put me into General Waste :(\"\n\n            # Add points to user goals\n            current_user = request.user\n\n            if (binType):\n                print(binType)\n                thisUserGoals = UserGoal.objects.filter(\n                    Q(goalType=binType) & Q(user=current_user))\n                for item in thisUserGoals:\n                    item.value += 1\n                    item.save()\n\n                # Delete full goals and add points\n                for item in thisUserGoals:\n                    if (item.value >= 100):\n                        item.delete()\n                        points += 100\n\n            data = Transaction.objects.all()[:5]\n            data_dict = {\n                'Transaction': data,\n                'popup': 1,\n                'newPoints': 1,\n                'product': product_data.name,\n                'points': points,\n                'newhome': new_home\n            }\n            print(\"k\")\n            print(data_dict)\n            return render(request, 'home/index.html', data_dict)\n        return redirect('barcode_lookup')\n    except Exception as e:\n        print(e)\n        # They tried to scam us and haven't scanned a product\n        return redirect('barcode_lookup')\n\n\ndef api_lookup(barcode):\n    print(\"d\")\n    api_key = \"5bcg2pbed762819eeppkc2qhjak1l4\"\n    url = \"https://api.barcodelookup.com/v3/products?barcode=\" + \\\n        barcode + \"&formatted=y&key=\" + api_key\n    print(\"j\")\n    with urllib.request.urlopen(url) as url:\n        data = json.loads(url.read().decode())\n    print(\"l\")\n    print(data)\n    print(\"\\n\")\n    data = data[\"products\"][0]\n    return data\n\n\ndef database_lookup(request):\n    print(request.POST)\n    barcode_camera = request.POST.get(\"barcode\")\n    print(\"Value is \", barcode_camera)\n    if Product.objects.filter(barcode=barcode_camera).exists():\n        print(\"in db\")\n        product_data = Product.objects.get(barcode=barcode_camera)\n        print(product_data)\n    else:\n        print(\"not in db\")\n\n\ndef addstats(user, product, points: int, kg=0):\n    user_stats = Statistic.objects.get(user=user)\n    user_stats.points += points\n    kg *= 0.09\n    kg = round(kg, 3)\n    user_stats.curweek = round((user_stats.curweek + kg), 3)  # change field\n    user_stats.curmonth = round((user_stats.curmonth + kg), 3)\n    user_stats.curyear = round((user_stats.curyear + kg), 3)\n    user_stats.lastRecycle = product\n    user_stats.save()  # this will update only\n\n\ndef bin_map(request):\n\n    # bin_general = models.BooleanField(default=False)\n    # bin_recycle = models.BooleanField(default=False)\n    # bin_paper = models.BooleanField(default=False)\n    # bin_cans = models.BooleanField(default=False)\n    # bin_glass = models.BooleanField(default=False)\n    # bin_plastic = models.BooleanField(default=False)\n    # bin_non_rec = models.BooleanField(default=False)\n\n    data = BinData.objects.all()\n    \n    data_dict = {'Bins': data}\n\n    return render(request, 'BCscanner/bin_map.html', data_dict)\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/bytebrigade/barcodereader/views.py b/bytebrigade/barcodereader/views.py
--- a/bytebrigade/barcodereader/views.py	(revision a890114a1dd82451762cccd74de8892c6801417c)
+++ b/bytebrigade/barcodereader/views.py	(date 1678731773334)
@@ -91,7 +91,6 @@
             request.session['valid'] = -1
         # Call a function that will take in the calculate the points for the user
         # If the product is new add points, this is handle in the create product part
-        # def addstats(points,kg)
             weight = product_data.weight
             points = round(weight * 122)
             # need to include the product
